{% extends "base.html" %}

{% block content %}
<div class="container py-4 px-md-5">
    <!-- Header -->
    <div class="mb-4 animate-fade-in-up">
        <a href="/admin/dashboard" class="btn btn-outline-secondary rounded-pill px-4 mb-3 hover-scale">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="fw-bold text-dark mb-0">Patient Management</h1>
            </div>
            <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="refreshPatients()">
                <i class="fas fa-sync-alt me-2"></i>Refresh List
            </button>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 animate-fade-in-up delay-1">
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group rounded-pill overflow-hidden border shadow-sm">
                        <span class="input-group-text bg-white border-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="patient-search" class="form-control border-0 px-2 py-2"
                            placeholder="Search by name, email, or risk status...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="risk-filter" class="form-select rounded-pill border shadow-sm px-3"
                        onchange="filterPatients()">
                        <option value="All">All Risk Levels</option>
                        <option value="High">High Risk</option>
                        <option value="Medium">Medium Risk</option>
                        <option value="Low">Low Risk</option>
                        <option value="No Data">No Data</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="sort-order" class="form-select rounded-pill border shadow-sm px-3"
                        onchange="filterPatients()">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="score-desc">Risk Score (High-Low)</option>
                        <option value="score-asc">Risk Score (Low-High)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Table -->
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden animate-fade-in-up delay-2">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="patients-table">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4 py-3 border-0">Patient Info</th>
                            <th class="py-3 border-0">Risk Status</th>
                            <th class="py-3 border-0 text-center">Score</th>
                            <th class="py-3 border-0 text-center">Last Assessment</th>
                            <th class="pe-4 py-3 border-0 text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patient-list">
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="spinner-border text-primary me-2" role="status"></div>
                                <span class="fw-bold">Loading patient records...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="no-patients-msg" class="text-center py-5 d-none">
                <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                <h5 class="fw-bold text-muted">No patient records match your criteria</h5>
                <p class="text-muted small">Try adjusting your filters or search query.</p>
            </div>
        </div>
    </div>
</div>

<style>
    .badge-high {
        background-color: #dc3545;
    }

    .badge-medium {
        background-color: #ffc107;
        color: #000;
    }

    .badge-low {
        background-color: #28a745;
    }

    .badge-none {
        background-color: #6c757d;
    }

    .hover-scale {
        transition: transform 0.2s;
    }

    .hover-scale:hover {
        transform: scale(1.05);
    }

    .avatar {
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", refreshPatients);

    const searchInput = document.getElementById('patient-search');
    searchInput.addEventListener('input', filterPatients);

    let allPatients = [];

    async function refreshPatients() {
        try {
            const tbody = document.getElementById('patient-list');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="spinner-border text-primary me-2" role="status"></div>
                        <span class="fw-bold">Fetching latest records...</span>
                    </td>
                </tr>
            `;

            const response = await fetch('/api/admin/patients');
            const data = await response.json();

            allPatients = data.patients;
            filterPatients();
        } catch (error) {
            console.error('Error fetching patients:', error);
            document.getElementById('patient-list').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger py-5 fw-bold">
                        <i class="fas fa-exclamation-circle me-2"></i>Failed to synchronise with server.
                    </td>
                </tr>
            `;
        }
    }

    function filterPatients() {
        const query = searchInput.value.toLowerCase();
        const riskLevel = document.getElementById('risk-filter').value;
        const sortBy = document.getElementById('sort-order').value;

        let filtered = allPatients.filter(p => {
            const matchesSearch = p.name.toLowerCase().includes(query) || p.email.toLowerCase().includes(query);
            const matchesRisk = riskLevel === 'All' || p.latest_risk === riskLevel;
            return matchesSearch && matchesRisk;
        });

        // Sorting
        filtered.sort((a, b) => {
            if (sortBy === 'name-asc') return a.name.localeCompare(b.name);
            if (sortBy === 'name-desc') return b.name.localeCompare(a.name);
            if (sortBy === 'score-desc') return (b.latest_score || 0) - (a.latest_score || 0);
            if (sortBy === 'score-asc') return (a.latest_score || 0) - (b.latest_score || 0);
            return 0;
        });

        renderTable(filtered);
    }

    function renderTable(patients) {
        const tbody = document.getElementById('patient-list');
        const noPatientsMsg = document.getElementById('no-patients-msg');

        if (patients.length === 0) {
            tbody.innerHTML = '';
            noPatientsMsg.classList.remove('d-none');
            return;
        }

        noPatientsMsg.classList.add('d-none');
        tbody.innerHTML = patients.map(p => {
            const riskClass = p.latest_risk === 'High' ? 'badge-high' :
                (p.latest_risk === 'Medium' ? 'badge-medium' :
                    (p.latest_risk === 'Low' ? 'badge-low' : 'badge-none'));

            const scoreDisplay = p.latest_score !== null ? `${p.latest_score}%` : '---';
            const initial = p.name.charAt(0).toUpperCase();

            return `
                <tr>
                    <td class="ps-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="avatar bg-primary bg-opacity-10 text-primary rounded-circle me-3">
                                ${initial}
                            </div>
                            <div>
                                <div class="fw-bold text-dark">${p.name}</div>
                                <div class="small text-muted">${p.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-3">
                        <span class="badge ${riskClass} rounded-pill px-3 py-2 fw-bold" style="min-width: 90px;">
                            ${p.latest_risk}
                        </span>
                    </td>
                    <td class="py-3 text-center fw-bold text-dark">${scoreDisplay}</td>
                    <td class="py-3 text-center text-muted small">${p.last_visit}</td>
                    <td class="pe-4 py-3 text-end">
                        <div class="btn-group shadow-sm rounded-pill overflow-hidden">
                            <a href="/admin/patient/${p.id}" class="btn btn-sm btn-primary px-3">
                                <i class="fas fa-file-medical me-1"></i>Report
                            </a>
                            <button class="btn btn-sm btn-outline-primary px-3" onclick="window.location.href='/admin/patient/${p.id}'">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
</script>
{% endblock %}