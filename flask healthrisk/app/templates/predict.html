{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4 text-center">ü©∫ Health Risk Prediction</h2>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg mb-5" style="border-radius: 20px; border: none;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Enter Key Health Metrics</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <!-- Row 1: Demographics -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Age (Years)</label>
                                <input type="number" name="age" class="form-control" placeholder="e.g. 45" min="1"
                                    max="120" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Gender</label>
                                <select name="gender" class="form-select">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Family History of Diabetes</label>
                                <select name="family_history_diabetes" class="form-select">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </div>
                        </div>

                        <!-- Row 2: Vitals -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">BMI</label>
                                <input type="number" step="0.1" name="bmi" class="form-control" placeholder="e.g. 24.5"
                                    min="10" max="60" required>
                                <div class="form-text">Healthy range: 18.5 - 24.9</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Systolic BP (mmHg)</label>
                                <input type="number" name="systolic_bp" class="form-control" placeholder="e.g. 120"
                                    min="70" max="250" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Diastolic BP (mmHg)</label>
                                <input type="number" name="diastolic_bp" class="form-control" placeholder="e.g. 80"
                                    min="40" max="150" required>
                            </div>
                        </div>

                        <!-- Row 3: Labs -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">HbA1c (%)</label>
                                <input type="number" step="0.1" name="hba1c" class="form-control" placeholder="e.g. 5.7"
                                    min="3.0" max="20.0" required>
                                <div class="form-text">Normal is below 5.7%</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fasting Glucose (mg/dL)</label>
                                <input type="number" name="glucose_fasting" class="form-control" placeholder="e.g. 100"
                                    min="50" max="500" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Total Cholesterol (mg/dL)</label>
                                <input type="number" name="cholesterol_total" class="form-control"
                                    placeholder="e.g. 200" min="100" max="400" required>
                            </div>
                        </div>

                        <!-- Row 4: Lifestyle -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Physical Activity (Min/Week)</label>
                                <input type="number" name="physical_activity_minutes_per_week" class="form-control"
                                    placeholder="e.g. 150" min="0" max="1000" required>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg">Analyze Risk</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Results Display -->
    {% if result %}
    <div class="row justify-content-center mt-5">
        <div class="col-lg-10">

            <!-- 1. Risk Donut Chart Monitor -->
            <div class="card shadow-lg mb-4" style="border-radius: 20px;">
                <div class="card-body text-center p-5"
                    style="background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%); border-radius: 20px;">
                    <h5 class="fw-bold mb-4 text-primary text-uppercase small tracking-wider">Risk Diagnostic Monitor
                    </h5>
                    {{ gauge | safe }}

                    <div class="mt-4">
                        <span class="badge rounded-pill px-4 py-2 fs-5 shadow-sm
                            {% if result.risk == 'Low' %}bg-success
                            {% elif result.risk == 'Medium' %}bg-warning text-dark
                            {% else %}bg-danger{% endif %}">
                            {{ result.risk }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- 2. Health Monitoring & Alerts (Conditionally shown) -->
            {% if result.alerts %}
            <div class="card shadow-lg mb-4 {% if result.risk == 'Low' %}risk-border-low{% elif result.risk == 'Medium' %}risk-border-medium{% else %}risk-border-high{% endif %}"
                style="border-radius: 20px;">
                <div class="card-body p-4">
                    <h5 class="mb-4 fw-bold text-dark text-center">Health Monitoring Alerts</h5>
                    <div class="row g-2">
                        {% for icon, title, category in result.alerts %}
                        <div class="col-12">
                            <div class="alert alert-{{ category }} border-0 shadow-sm d-flex align-items-center mb-1">
                                <span class="me-3 fs-4">{{ icon }}</span>
                                <div class="fw-bold">{{ title }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 3. Personalized Recommendations -->
            <div class="card shadow-lg mb-4" style="border-radius: 20px;">
                <div class="card-body p-4 p-md-5">
                    <h5 class="mb-4 fw-bold text-dark text-center"><i
                            class="bi bi-stars text-warning me-2"></i>Personalized
                        Lifestyle Tips</h5>
                    <div class="row g-3">
                        {% if result.recs %}
                        {% for icon, title, desc in result.recs %}
                        <div class="col-md-6">
                            <div class="d-flex align-items-start p-3 border rounded-3 h-100 shadow-sm bg-light">
                                <span class="me-3 fs-3">{{ icon }}</span>
                                <div>
                                    <h6 class="fw-bold mb-1">{{ title }}</h6>
                                    <p class="mb-0 small text-muted">{{ desc }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>




            <!-- 4. Personal Insights with 5 Interactive Graphs -->
            <div class="card shadow-lg mb-4" style="border-radius: 20px;">
                <div class="card-body p-4 p-md-5">
                    <h5 class="mb-4 fw-bold text-dark">
                        <i class="bi bi-graph-up-arrow me-2"></i>Personal Insights
                    </h5>

                    <!-- Graph Row 1: Impact & Vitals -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-transparent border-0">
                                    <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-bar-chart-fill me-2"></i>Impact
                                        on Risk Score</h6>
                                </div>
                                <div class="card-body">
                                    <div class="collapse mb-2" id="explainImpact">
                                        <div class="alert alert-info small mb-2">
                                            <strong>What this shows:</strong> This chart displays which health factors
                                            are contributing most to your diabetes risk score. Longer bars indicate
                                            factors that have a greater impact on your overall risk. Focus on the top
                                            factors to make the most effective improvements.
                                        </div>
                                    </div>
                                    {{ result.charts.impact | safe }}
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#explainImpact">
                                            <i class="bi bi-question-circle me-1"></i>Explain
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-transparent border-0">
                                    <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-activity me-2"></i>Your Vitals vs
                                        Target</h6>
                                </div>
                                <div class="card-body">
                                    <div class="collapse mb-2" id="explainVitals">
                                        <div class="alert alert-info small mb-2">
                                            <strong>What this shows:</strong> This comparison chart shows your current
                                            vital measurements (HbA1c, Glucose, BMI) against healthy target values. Bars
                                            extending beyond the target line indicate areas that need improvement. The
                                            closer your values are to the targets, the lower your diabetes risk.
                                        </div>
                                    </div>
                                    {{ result.charts.vitals | safe }}
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#explainVitals">
                                            <i class="bi bi-question-circle me-1"></i>Explain
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graph Row 2: Radar & BP Map -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-transparent border-0">
                                    <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-radar me-2"></i>Risk Factors
                                        Analysis</h6>
                                </div>
                                <div class="card-body">
                                    <div class="collapse mb-2" id="explainRadar">
                                        <div class="alert alert-info small mb-2">
                                            <strong>What this shows:</strong> This multi-dimensional analysis evaluates
                                            various risk factors simultaneously. Each axis represents a different health
                                            metric. A larger shape indicates higher risk across multiple factors. Aim
                                            for a smaller, more balanced shape by improving weak areas.
                                        </div>
                                    </div>
                                    {{ result.charts.radar | safe }}
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#explainRadar">
                                            <i class="bi bi-question-circle me-1"></i>Explain
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-transparent border-0">
                                    <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-heart-pulse-fill me-2"></i>Blood
                                        Pressure Map</h6>
                                </div>
                                <div class="card-body">
                                    <div class="collapse mb-2" id="explainBP">
                                        <div class="alert alert-info small mb-2">
                                            <strong>What this shows:</strong> This visualization maps your blood
                                            pressure readings against standard health zones. The colored regions
                                            indicate Normal (green), Elevated (yellow), and Hypertension (red) ranges.
                                            Your position on the map shows your current BP status and diabetes risk
                                            correlation.
                                        </div>
                                    </div>
                                    {{ result.charts.bp_map | safe }}
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#explainBP">
                                            <i class="bi bi-question-circle me-1"></i>Explain
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graph Row 3: Risk Curve (Full Width) -->
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-transparent border-0">
                                    <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-graph-up me-2"></i>Risk
                                        Progression Curve</h6>
                                </div>
                                <div class="card-body">
                                    <div class="collapse mb-2" id="explainCurve">
                                        <div class="alert alert-info small mb-2">
                                            <strong>What this shows:</strong> This curve illustrates how your diabetes
                                            risk increases with changes in key health metrics. The steeper the curve,
                                            the faster risk accelerates. This helps you understand critical thresholds
                                            where small improvements can make a big difference in reducing your overall
                                            risk.
                                        </div>
                                    </div>
                                    {{ result.charts.curve | safe }}
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#explainCurve">
                                            <i class="bi bi-question-circle me-1"></i>Explain
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Summary Report -->
            <div class="card shadow-lg mb-4" style="border-radius: 20px;">
                <div class="card-body p-4 p-md-5">
                    <h5 class="mb-4 fw-bold text-dark text-center">
                        <i class="bi bi-file-earmark-text me-2"></i>Health Summary Report
                    </h5>
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded-3 h-100">
                                <div class="fs-1 mb-2">üìä</div>
                                <h6 class="fw-bold text-primary">Risk Score</h6>
                                <p
                                    class="fs-3 fw-bold mb-1 {% if result.risk == 'Low' %}text-success{% elif result.risk == 'Medium' %}text-warning{% else %}text-danger{% endif %}">
                                    {{ result.score }}%
                                </p>
                                <p class="small text-muted mb-0">{{ result.risk }} Risk Level</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded-3 h-100">
                                <div class="fs-1 mb-2">‚ö†Ô∏è</div>
                                <h6 class="fw-bold text-primary">Health Alerts</h6>
                                <p class="fs-3 fw-bold mb-1">{{ result.alerts|length if result.alerts else 0 }}</p>
                                <p class="small text-muted mb-0">Concerns Detected</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded-3 h-100">
                                <div class="fs-1 mb-2">üí°</div>
                                <h6 class="fw-bold text-primary">Recommendations</h6>
                                <p class="fs-3 fw-bold mb-1">{{ result.recs|length if result.recs else 0 }}</p>
                                <p class="small text-muted mb-0">Lifestyle Tips</p>
                            </div>
                        </div>
                    </div>


                    <!-- Current Assessment (Risk Level) -->
                    <div class="mt-4 p-4 rounded-3 position-relative"
                        style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                        <h6 class="fw-bold mb-3 text-dark"><i class="bi bi-clipboard-check me-2"></i>Your Health Status
                        </h6>
                        <div class="mb-0">
                            {% if result.score < 30 %} <span class="badge bg-success fs-6 me-2">Low Risk</span>
                                <p class="mb-0 mt-2">Low risk detected. Your metrics are healthy. Keep up the good work
                                    to maintain this status!</p>
                                {% elif result.score < 70 %} <span class="badge bg-warning text-dark fs-6 me-2">Medium
                                    Risk</span>
                                    <p class="mb-0 mt-2">Moderate risk. Your metrics suggest some attention is needed.
                                        Small lifestyle changes can help improve your health.</p>
                                    {% else %}
                                    <span class="badge bg-danger fs-6 me-2">High Risk</span>
                                    <p class="mb-0 mt-2">High risk. Immediate medical consultation is recommended to
                                        address concerning metrics and prevent complications.</p>
                                    {% endif %}
                        </div>

                    </div>


                    <!-- Personalized Suggestions in Cards -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3 text-dark"><i class="bi bi-lightbulb-fill me-2"></i>Personalized Health
                            Recommendations</h6>
                        <div class="row g-3">
                            {% if result.suggestions %}
                            {% for suggestion in result.suggestions %}
                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm border-0 bg-white">
                                    <div class="card-body p-3">
                                        <p class="mb-0 small"><i
                                                class="bi bi-check-circle-fill text-primary me-2"></i>{{ suggestion }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm border-0 bg-white">
                                    <div class="card-body p-3">
                                        <p class="mb-0 small"><i
                                                class="bi bi-check-circle-fill text-success me-2"></i>Continue
                                            maintaining your excellent health habits</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm border-0 bg-white">
                                    <div class="card-body p-3">
                                        <p class="mb-0 small"><i
                                                class="bi bi-check-circle-fill text-success me-2"></i>Schedule regular
                                            health checkups every 6 months</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Next Steps in Card Format -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3 text-dark"><i class="bi bi-arrow-right-circle me-2"></i>Recommended
                            Follow-up</h6>
                        <div class="card shadow-sm border-0 bg-white">
                            <div class="card-body p-3">
                                <p class="mb-0">
                                    {% if result.score < 30 %} <i class="bi bi-calendar-check text-info me-2">
                                        </i>Continue healthy habits and reassess in <strong>6 months</strong>.
                                        {% elif result.score < 70 %} <i class="bi bi-calendar-event text-warning me-2">
                                            </i>Implement recommended lifestyle changes and reassess in <strong>3
                                                months</strong>.
                                            {% else %}
                                            <i class="bi bi-calendar-x text-danger me-2"></i>Schedule a medical
                                            consultation within <strong>2 weeks</strong> and begin immediate lifestyle
                                            modifications.
                                            {% endif %}
                                </p>
                            </div>
                        </div>

                        <div class="text-muted small text-end mt-3">
                            Assessment Date: {{ result.timestamp }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}